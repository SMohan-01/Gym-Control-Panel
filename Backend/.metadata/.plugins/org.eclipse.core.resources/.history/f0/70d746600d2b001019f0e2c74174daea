package in.mohan.gym_management_system.utility;

public class JwtAuthenticationFilter extends OncePerRequestFilter{
	
	 private final JwtUtility jwtUtility;

	    public JwtAuthenticationFilter(JwtUtility jwtUtility) {
	        this.jwtUtility = jwtUtility;
	    }

	    @Override
	    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
	                                    FilterChain filterChain) throws ServletException, IOException {

	        String token = extractToken(request);

	        if (StringUtils.hasText(token) && jwtUtility.validateToken(token)) {
	            String username = jwtUtility.extractUsername(token);

	            UsernamePasswordAuthenticationToken auth =
	                    new UsernamePasswordAuthenticationToken(username, null, null);
	            auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
	            SecurityContextHolder.getContext().setAuthentication(auth);
	        }

	        filterChain.doFilter(request, response);
	    }

	    private String extractToken(HttpServletRequest request) {
	        String bearerToken = request.getHeader("Authorization");
	        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
	            return bearerToken.substring(7); // Remove "Bearer "
	        }
	        return null;
	    }

}
